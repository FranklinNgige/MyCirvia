import { Injectable } from '@nestjs/common';
import { MediaRepository } from '../../media/media.repository';
import { MalwareScanner } from '../scanners/malware-scanner.interface';

@Injectable()
export class MalwareScanJob {
  constructor(
    private readonly scanner: MalwareScanner,
    private readonly mediaRepository: MediaRepository,
  ) {}

  async process(key: string) {
    const result = await this.scanner.scanFile(key);
    if (!result.clean) {
      this.mediaRepository.updateStatus(key, 'failed');
      throw new Error(`Malware detected for ${key}: ${(result.threats ?? []).join(',')}`);
    }
  }
}
